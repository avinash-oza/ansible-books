---
- name: install virtualenv and other requirements
  apt: pkg={{item}}  state=installed update_cache=false
  with_items:
    - git
    - python-pip
    - python-virtualenv
    - python3-pip

- name: Create telegram user
  user:
    name: "{{ telegram_user_account }}"
    state: present

- name: checkout telegram-bot
  git:
    repo: "{{ telegram_bot_repo }}"
    dest: "{{ telegram_checkout_location }}"
    accept_hostkey: yes
    force: yes

- name: install telegram-bot virtualenv
  pip:
    requirements: "{{ telegram_checkout_location }}/requirements.txt"
    virtualenv_python: python3
    virtualenv: "{{ telegram_bot_virtual_env_location }}"

- name: Create telegram-bot start file
  template:
    src: start_telegram_bot.sh
    dest: "{{ telegram_checkout_location }}/start_telegram_bot.sh"
    owner: "{{ telegram_user_account }}"
    group: "{{ telegram_user_account }}"
    mode: 0755

- name: Create telegram-bot config file
  template:
    src: bot.config
    dest: "{{ telegram_checkout_location }}/bot.config"
    owner: "{{ telegram_user_account }}"
    group: "{{ telegram_user_account }}"
    mode: 0744

- name: Convert ownership of all files in home directory to user
  file:
    path: "/home/{{ telegram_user_account }}"
    owner: "{{ telegram_user_account }}"
    group: "{{ telegram_user_account }}"
    state: directory
    recurse: yes

- name: Configure rotation of logfile
  template:
    src: telegram_log_rotate
    dest: "/etc/logrotate.d/telegram_log_rotate"

- name: "Create logfile location {{ telegram_log_location }}"
  become: yes
  file:
    path: "{{ telegram_log_location }}"
    state: directory
    owner: "{{ telegram_user_account }}"
    group: "{{ telegram_user_account }}"
    mode: 0755
  
- name: Copy systemd file for starting telegram-bot on boot
  become: yes
  template:
    src: telegram-bot.service
    dest: /etc/systemd/system
    mode: 0644

- name: Enable telegram-bot to run on boot and start
  become: yes
  service:
    name: telegram-bot.service
    state: restarted
    enabled: true
